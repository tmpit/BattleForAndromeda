<html>
<head>
	<title>test</title>
	<script type="text/javascript" src="../src/core/sra.js"></script>
	<script type="text/javascript">
		var cache = new Graphics.Image.Cache();

		function testSpriteAnimation() {
			var scene = getGameController().getTopScene();

			for (var i = 0; i < 1; i++) {
				var node = new SRA.Entity();
				node.backgroundColor = null;
				node.rect.origin.x = 100.0;
				node.rect.origin.y = 100.0;
				node.rect.size.width = 27.0;
				node.rect.size.height = 40.0;
				node.anchor = new Geometry.Vector2(0.5, 0.75);
				node.rotation = Geometry.degreesToRadians(90.0);
				node.sprite = cache.imageForKey('gordon_freeman.png');
				node.contentMode = Graphics.Image.ContentMode.Center;
				scene.addChild(node);

				var moveRight = new SRA.MoveByAction(new Geometry.Vector2(250.0, 0.0), 2.0, 1.0);
				moveRight.setTimingFunction(SRA.TimingFunction.EaseInOut);
				var moveDown = new SRA.MoveByAction(new Geometry.Vector2(0.0, 150.0), 2.0, 1.0);
				moveDown.setTimingFunction(SRA.TimingFunction.EaseInOut);
				var moveLeft = new SRA.MoveByAction(new Geometry.Vector2(-250.0, 0.0), 2.0, 1.0);
				moveLeft.setTimingFunction(SRA.TimingFunction.EaseInOut);
				var moveUp = new SRA.MoveByAction(new Geometry.Vector2(0.0, -150.0), 2.0, 1.0);
				moveUp.setTimingFunction(SRA.TimingFunction.EaseInOut);
				var rotateRight = new SRA.RotateByAction(Geometry.degreesToRadians(90.0), 1.2, 1.0);
				rotateRight.setTimingFunction(SRA.TimingFunction.EaseInOut);
				var delay = new SRA.DelayAction(0.2, 1.0);
				var actions = [delay, moveRight, delay, rotateRight, delay, moveDown, delay, rotateRight, 
								delay, moveLeft, delay, rotateRight, delay, moveUp, delay, rotateRight];
				var sequence = new SRA.ActionSequence(actions);
				var repeat = new SRA.RepeatAction(sequence, -1);
				node.addAction(repeat);
			}
		}

		function testActionPauseResume() {
			var scene = getGameController().getTopScene();

			var node = new SRA.Entity();
			node.backgroundColor = null;
			node.rect.origin.x = 100.0;
			node.rect.origin.y = 100.0;
			node.rect.size.width = 27.0;
			node.rect.size.height = 40.0;
			node.anchor = new Geometry.Vector2(0.5, 0.75);
			node.rotation = Geometry.degreesToRadians(90.0);
			node.sprite = cache.imageForKey('gordon_freeman.png');
			node.contentMode = Graphics.Image.ContentMode.Center;
			scene.addChild(node);

			var moveRight = new SRA.MoveByAction(new Geometry.Vector2(100.0, 0.0), 2.0, 1.0);
			var moveDown = new SRA.RotateByAction(Geometry.degreesToRadians(90.0), 2.0, 1.0);
			var action = new SRA.ActionSequence([moveRight, moveDown]);
			node.addAction(action);

			setTimeout(function () {
				action.pause();
				setTimeout(function () {
					action.resume();
				}, 1000);
			}, 2000);
		}

		function testActionInterrupt() {
			var scene = getGameController().getTopScene();

			var node = new SRA.Entity();
			node.backgroundColor = null;
			node.rect.origin.x = 100.0;
			node.rect.origin.y = 100.0;
			node.rect.size.width = 27.0;
			node.rect.size.height = 40.0;
			node.anchor = new Geometry.Vector2(0.5, 0.75);
			node.sprite = cache.imageForKey('gordon_freeman.png');
			node.contentMode = Graphics.Image.ContentMode.Center;
			scene.addChild(node);

			var moveRight = new SRA.MoveByAction(new Geometry.Vector2(50.0, 0.0), 2.0, 1.0);
			var rotate = new SRA.RotateByAction(Geometry.degreesToRadians(90.0), 3.0, 1.0);
			var action = new SRA.ActionSequence([moveRight, rotate]);
			node.addAction(action);

			setTimeout(function () {
				action.end(false);
			}, 1000);
		}

		var observer;
		var ship;

		function addBackground() {
			var space = new SRA.Entity();
			space.sprite = cache.imageForKey('space.jpg');
			space.rect.size = new Geometry.Size(space.sprite.width, space.sprite.height);
			space.contentMode = Graphics.Image.ContentMode.Center;
			getGameController().getTopScene().addChild(space);

			var getStep = function (offset) {
				var direction = observer.mouse.getPosition().minus(ship.getPosition()).normalize();
				return direction.multiply(offset);
			}

			var update = function (delta) {
				var k = observer.keyboard;
				var verticalOffset = 200.0 * delta;
				var horizontalOffset = 200.0 * delta;
				var hor = null, ver = null, origin;

				if (k.W) {
					hor = space.rect.origin.minus(getStep(verticalOffset));
				} else if (k.S) {
					hor = space.rect.origin.plus(getStep(verticalOffset));
				}

				origin = hor;

				if (k.A) {
					ver = space.rect.origin.plus(getStep(horizontalOffset).rotated90Clockwise());
				} else if (k.D) {
					ver = space.rect.origin.minus(getStep(horizontalOffset).rotated90Clockwise());
				}

				if (ver) {
					if (!origin) {
						origin = ver;
					} else {
						origin.x = (origin.x + ver.x) / 2.0;
						origin.y = (origin.y + ver.y) / 2.0;	
					}
				}				

				if (origin) {
					space.rect.origin = origin;
				}
			}

			space.update = update;
			getGameController().scheduleUpdate(space, update);
		}

		function addSpaceShip() {
			var controller = getGameController();
			var canvasSize = controller.canvas.getSize();

			ship = new SRA.Entity();
			ship.backgroundColor = null;
			ship.sprite = cache.imageForKey('ship2.png');
			ship.rect.origin.x = (canvasSize.width - ship.sprite.width) / 2.0;
			ship.rect.origin.y = (canvasSize.height - ship.sprite.height) / 2.0;
			ship.rect.size = new Geometry.Size(ship.sprite.width, ship.sprite.height);
			ship.contentMode = Graphics.Image.ContentMode.Top;
			controller.getTopScene().addChild(ship);

			var action = new SRA.SpriteAction([cache.imageForKey('ship1.png'), cache.imageForKey('ship2.png')], 0.2, 1.0);
			var repeat = new SRA.RepeatAction(action, -1);
			ship.addAction(repeat);

			var update = function (delta) {
				var angle = observer.mouse.getPosition().minus(ship.getPosition()).angleFromXAxis();
				angle += Math.PI / 2.0; // shift angle so it's as if it's relative to the Y axis
				ship.rotation = angle;
			}

			ship.update = update;
			controller.scheduleUpdate(ship, update);
		}

		function startGame() {
			var canvas = document.getElementsByTagName('canvas')[0];
			var controller = SRA.Controller.getSharedInstance();
			controller.canvas = new Graphics.Canvas(canvas);
			controller.setFrameRate(60);

			var mainScene = new SRA.Scene();
			mainScene.backgroundColor = Graphics.Color.White;
			mainScene.rect.size = controller.canvas.getSize();
			controller.pushScene(mainScene);
			controller.run();

			observer = new Input.EventObserver();
			observer.startObservingKeyEvents();
			observer.startObservingMouseEvents(canvas);

			window.getGameController = function () {
				return controller;
			}

			addBackground();
			addSpaceShip();
		}

		var imagePaths = ['gordon_freeman.png', 'h_gray.png', 'h_white.png', 'h_red.png', 'h_blue.png', 'space.jpg', 'ship1.png', 'ship2.png'];
		var loader = new Graphics.Image.Loader(imagePaths, cache, startGame);

		window.onload = function () {
			loader.start();
		}
	</script>
</head>
<body>
	<canvas width="600" height="400">
	</canvas>
</body>
</html>
